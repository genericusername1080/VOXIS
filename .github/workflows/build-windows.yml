name: Build Windows Release

on:
  workflow_dispatch: # Allows manual trigger from the GitHub Actions tab
  release:
    types: [created] # Runs automatically when a new GitHub Release is created

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive # Just in case

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Use LTS

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install System Dependencies
        run: |
          # FFmpeg is usually pre-installed on GitHub Actions Windows runners,
          # but let's download a static build to bundle it just to be safe.
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg-bin"
          New-Item -ItemType Directory -Force -Path "backend/bin/win"
          Copy-Item "ffmpeg-bin/ffmpeg-master-latest-win64-gpl/bin/ffmpeg.exe" -Destination "backend/bin/win/"
          echo "FFmpeg downloaded and bundled."

      - name: Setup Python Environment and Install Dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller "audio-separator[cpu]" "audiosr>=0.0.7" torchcodec

      - name: Download AI Models
        working-directory: ./backend
        run: |
          python download_models.py
          # Ensure UVR model is downloaded
          python -c "from audio_separator.separator import Separator; Separator(model_file_dir='models/TrinityDense').load_model('UVR-MDX-NET-Voc_FT.onnx')"

      - name: Build Python Backend (PyInstaller)
        working-directory: ./backend
        run: |
          python -m PyInstaller --noconfirm --clean --distpath dist --workpath build voxis.spec

      - name: Build React Frontend
        run: |
          npm install
          npm run build

      - name: Build Electron App (Windows Installer & Portable)
        working-directory: ./installer
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm install
          npm run build:win

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VOXIS-Windows-Builds
          path: |
            installer/dist/*.exe
          retention-days: 7
